---
title: "Rcdm Package Demo"
author: "Michel Philipp"
date: "30 September 2016"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Installation

To install the package from the source code, Rcpp and RcppArmadillo are re-
quired. If you have not installed Rcpp and RcppArmadillo packages, run:
```{r, eval=FALSE}
install.packages(c("Rcpp", "RcppArmadillo"))
```

Then, install the package either by the command:
```{r, eval=FALSE}
install.packages("Rcdm_0.1-0.tar.gz", repos = NULL, type = "source")
```
or if you are using RStudio go to ”Packages - Install - Install from” and choose
”Package Archive File” then Browse the File and klick Install. Alternatively
your can install Rcdm directly from GitHub:
```{r, eval=FALSE}
install.packages("devtools") # if you have not installed devools
devtools::install_github("mphili/cdm")
```

Rcdm currently depends on Rcpp, Matrix, limSolve and gtools packages, that
need to be installed on your system.

```{r, eval=FALSE}
install.packages(c("Rcpp", "Matrix", "limSolve", "gtools"))
```

\newpage

## Fitting a GDINA model

```{r, message=FALSE}
library("Rcdm")
```

Load your own data or use the data example from the pks package:
```{r}
# install.packages("pks")
data("probability", package = "pks")

# reduce to 12 items from the first test
items <- sprintf("b1%.2i", 1:12)
resp <- probability[, items]
resp <- resp[complete.cases(resp),]

qmat <- t(read.table(header = FALSE, text = "
  0    1    0    0    1    1    0    0    0    1    1    0
  0    0    0    1    0    0    0    0    1    1    1    1
  1    0    0    0    1    1    1    1    1    0    1    1
  0    0    1    0    0    0    1    1    0    0    0    1
"))

colnames(qmat) <- c("cp", "id", "pb", "un")
rownames(qmat) <- colnames(resp)
```

Fit a GDINA model using the Rcdm package:
```{r}
mGDINA <- gdina(resp, qmat)
```

Plot the estimated conditional response probabilities:
```{r, fig.height=9}
plot(mGDINA)
```

\newpage

## Analyzing the Result

### Parameter Estimates 

Extract the estimates of the item parameters:
```{r}
mGDINA$dj
```

Extract the estimates of the latent class distribution
```{r}
mGDINA$pa
```

Extract the estimates of the response probabilities:
```{r}
mGDINA$pj
```

Get a nice table that contains the estimates of the item parameters:
```{r}
coef(mGDINA)
```

### Standard Errors

Compute the (correct) variance covariance matrix of all model parameters:
```{r}
v0 <- vcov(mGDINA)
```

Compute the (incorrect) variance covariance matrix by ignoring the 
skill parameters:
```{r}
v1 <- vcov(mGDINA, type = "partial")
```

Compute the (incorrect) variance covariance matrix by item-wise computation 
of the information matrix:
```{r}
v2 <- vcov(mGDINA, type = "itemwise")
```

#### Standard errors for the item parameters

```{r}
cbind("full (correct)"       = sqrt(diag(v0))[seq(1, 2*nrow(qmat))],
      "partial (incorrect)"  = sqrt(diag(v1)),
      "itemwise (incorrect)" = sqrt(diag(v2)))
```

#### Standard errors for the parameter estimates of the latent class distribution

```{r}
sqrt(diag(v1))[-seq(1, 2*nrow(qmat))]
```

### Confidence intervals

Confidence intervals for the intem parameters using the correct computation 
of the standard errors:
```{r}
confint(mGDINA, alpha = 0.05)
```

### Item-level fit

Item-level comparison of saturated and reduced models (de la Torre, 2013):
```{r}
gdina_wald(mGDINA)
```

### Fit indices

```{r}
logLik(mGDINA)
BIC(mGDINA)
AIC(mGDINA)
```

\newpage

## Fitting Reduced Models

Fit the reduced DINA model
```{r}
mDINA <- gdina(resp, qmat, rule = "DINA")
```

Fit the reduced DINO model
```{r}
mDINO <- gdina(resp, qmat, rule = "DINO")
```

Fit the reduced ACDM
```{r}
mACDM <- gdina(resp, qmat, rule = "ACDM")
```

### Model comparisons

Compare (non-nested) models
```{r}
AIC(mDINA, mDINO, mACDM, mGDINA)
BIC(mDINA, mDINO, mACDM, mGDINA)
```

compare (nested) models
```{r}
anova(mDINA, mACDM, mGDINA)
anova(mDINO, mACDM, mGDINA)
```
